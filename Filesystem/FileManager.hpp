#ifndef TESTPROJECT_FILEMANAGER_HPP
#define TESTPROJECT_FILEMANAGER_HPP

#include <dirent.h>
#include <fcntl.h>
#include <unistd.h>
#include <algorithm>
#include <fstream>
#include <filesystem>

#include "../Utils/StringManipulations.hpp"

class FileManager
{
    std::ifstream _fstream;
    int _fd;

public:
    FileManager()
    {
    }

    FileManager(const std::string& path): _fstream(path.c_str())
    {
    }

    ~FileManager()
    {
        if(_fd != -1)
        {
            close(_fd);
            _fd = -1;
        }
        if(_fstream.is_open())
        {
            _fstream.close();
        }
    }

    static std::vector<pid_t> listDirEntrysDigits(const char* path) // to list /proc dir for pids
    {
        if(!std::filesystem::exists(path) || !std::filesystem::is_directory(path))
        {
            throw std::runtime_error("Fail Opening Directory");
        }

        std::vector<pid_t> pids;

        for(const auto& dir_entry : std::filesystem::directory_iterator(path))
        {
            if(dir_entry.is_directory())
            {
                auto dir_name = dir_entry.path().filename().string();

                if(std::all_of(dir_name.begin(), dir_name.end(), isdigit))
                {
                    pid_t pid = std::stoi(dir_name);
                    pids.emplace_back(pid);
                }
            }
        }

        return pids;
    }

    void openFile(const char* path, int flag)
    {
        _fd = open(path, flag);

        if(_fd == -1)
        {
            throw std::runtime_error("Failed open memory file");
        }
    }

    void seek(uint64_t offset)
    {
        if(lseek(_fd, offset, SEEK_SET) == 0)
        {
            throw std::runtime_error("Error seeking address offset");
        }
    }

    void readIntoBuffer(std::vector<char>& buffer, uint64_t size, uint64_t offset)
    {
        uint64_t bytes_read = pread(_fd, buffer.data(), size, offset);

        if(bytes_read == -1)
        {
            throw std::runtime_error("Error reading memory data");
        }
    }

    void openFileStream()
    {
        if(!_fstream.is_open())
        {
            throw std::runtime_error("Failed to open file");
        }
    }

    std::ifstream& getStreamFile()
    {
        return _fstream;
    }
};

#endif //TESTPROJECT_FILEMANAGER_HPP
